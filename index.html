<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sans Scale Calculator - Beta</title>
    <style>
        :root {
            --color-bg: #1a1d23;
            --color-surface: #252930;
            --color-surface-hover: #2d3139;
            --color-border: rgba(255, 255, 255, 0.1);
            --color-text: #e4e6eb;
            --color-text-secondary: #b0b3b8;
            --color-primary: #32b8c5;
            --color-primary-hover: #2da4b0;
            --color-accent: #ff5555;
            --color-success: #50fa7b;
            --color-warning: #ffb86c;
            --radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--color-border);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            color: var(--color-primary);
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--color-border);
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--color-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-text);
            font-size: 0.9rem;
        }

        /* Combined Input/Select Styling */
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 1;
            text-align: center;
            font-weight: bold;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            border-radius: var(--radius);
            padding: 10px;
        }

        .input-group select {
            flex: 2;
        }

        select {
            width: 100%;
            padding: 10px 12px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            color: var(--color-text);
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        /* Enhanced Slider Controls */
        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--color-bg);
            padding: 8px 12px;
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
        }

        .slider-btn {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-primary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 0;
            user-select: none;
        }
        
        .slider-btn:hover {
            background: var(--color-surface-hover);
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            background: var(--color-surface);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
        }

        .slider-value {
            min-width: 40px;
            text-align: right;
            font-weight: 600;
            color: var(--color-primary);
            font-size: 1.1rem;
        }

        /* Genre Selector */
        .genre-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--color-bg);
            padding: 4px;
            border-radius: var(--radius);
        }

        .genre-option {
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            transition: all 0.2s;
            border: 1px solid transparent;
            user-select: none;
        }

        .genre-option:hover {
            background: var(--color-surface-hover);
        }

        .genre-option.active {
            background: var(--color-primary);
            color: white;
            font-weight: 600;
            border-color: var(--color-primary);
        }

        button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }

        button:hover {
            background: var(--color-primary-hover);
        }

        button.secondary {
            background: var(--color-surface-hover);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        button.secondary:hover {
            background: var(--color-bg);
        }

        .result-box {
            background: var(--color-bg);
            border: 2px solid var(--color-primary);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .result-magnitude {
            font-size: 3rem;
            font-weight: 700;
            color: var(--color-primary);
            margin: 10px 0;
        }

        .result-tier {
            font-size: 1.1rem;
            color: var(--color-text-secondary);
            margin-top: 8px;
        }

        .result-multiplier {
            font-size: 1.2rem;
            color: var(--color-warning);
            margin-top: 8px;
        }

        .database {
            max-height: 600px;
            overflow-y: auto;
        }

        .boss-entry {
            background: var(--color-bg);
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid transparent;
        }

        .boss-entry:hover {
            background: var(--color-surface-hover);
            border-color: var(--color-primary);
        }

        .boss-entry.selected {
            border-color: var(--color-primary);
            background: var(--color-surface-hover);
        }

        .boss-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .boss-stats {
            display: flex;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            flex-wrap: wrap;
        }

        .boss-magnitude {
            color: var(--color-primary);
            font-weight: 600;
        }

        .tier-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .tier-baseline { background: rgba(100, 100, 100, 0.3); }
        .tier-hard { background: rgba(59, 130, 246, 0.3); }
        .tier-very-hard { background: rgba(147, 51, 234, 0.3); }
        .tier-extreme { background: rgba(234, 179, 8, 0.3); }
        .tier-unbeatable { background: rgba(239, 68, 68, 0.3); }
        .tier-impossible { background: rgba(220, 38, 38, 0.3); }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .comparison-table th {
            color: var(--color-primary);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .comparison-table td {
            font-size: 0.9rem;
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-top: 8px;
            font-style: italic;
        }

        .guide-section {
            background: var(--color-surface);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--color-border);
        }

        .guide-section h3 {
            color: var(--color-primary);
            margin-bottom: 12px;
        }

        .guide-section ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .guide-section li {
            margin-bottom: 6px;
            color: var(--color-text-secondary);
        }

        .parameter-guide {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .parameter-card {
            background: var(--color-bg);
            padding: 12px;
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
        }

        .parameter-card h4 {
            color: var(--color-primary);
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .parameter-card p {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 6px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 8px 16px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .tab:hover {
            border-color: var(--color-primary);
        }

        .tab.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .practice-ceiling-line {
            border-top: 2px dashed var(--color-accent);
            margin: 16px 0;
            padding-top: 8px;
        }

        .practice-ceiling-label {
            color: var(--color-accent);
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
        }

        .collapsible {
            cursor: pointer;
            user-select: none;
        }

        .collapsible:hover {
            color: var(--color-primary);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.active {
            max-height: 2000px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sans Scale Calculator</h1>
            <div class="subtitle">Beta - Simplified Boss Difficulty Measurement</div>
            <div class="subtitle" style="margin-top: 8px; font-size: 0.85rem;">
                <strong>Practice Ceiling (SS ~1.20-1.30):</strong> The threshold where practice alone is no longer sufficient.
            </div>
        </header>

        <!-- Guide Section -->
        <div class="guide-section">
            <h3 class="collapsible" onclick="toggleGuide()">Quick Start Guide (Click to Expand)</h3>
            <div id="guideContent" class="collapsible-content">
                <p style="margin-bottom: 12px;">The Sans Scale (SS) uses three parameters to calculate boss difficulty relative to Sans.</p>
                
                <div class="parameter-guide">
                    <div class="parameter-card">
                        <h4>Mechanical Intensity (MI)</h4>
                        <p><strong>What it measures:</strong> Input density, reaction speed, precision.</p>
                        <p><strong>Genre:</strong> Primary weight for "Action" bosses.</p>
                    </div>
                    
                    <div class="parameter-card">
                        <h4>Endurance Factor (EF)</h4>
                        <p><strong>What it measures:</strong> Duration, stamina drain, consistency.</p>
                        <p><strong>Genre:</strong> Primary weight for "Endurance" (Boss Rushes).</p>
                    </div>
                    
                    <div class="parameter-card">
                        <h4>Pattern Complexity (PC)</h4>
                        <p><strong>What it measures:</strong> Memorization, RNG, puzzle elements.</p>
                        <p><strong>Genre:</strong> Primary weight for "Tactical" bosses.</p>
                    </div>
                </div>

                <h4 style="margin-top: 16px; margin-bottom: 8px; color: var(--color-primary);">Interpreting Results</h4>
                <ul>
                    <li><strong>SS = 1.00:</strong> Same difficulty as Sans (baseline)</li>
                    <li><strong>SS = 1.10:</strong> ~2x harder than Sans</li>
                    <li><strong>SS = 1.30:</strong> ~5x harder than Sans</li>
                    <li><strong>SS = 1.50:</strong> ~10x harder than Sans</li>
                    <li><strong>SS = 2.00:</strong> ~100x harder than Sans</li>
                </ul>
            </div>
        </div>

        <div class="layout">
            <!-- Calculator Panel -->
            <div class="card">
                <h2>Calculate Boss Difficulty</h2>
                
                <div class="form-group">
                    <label>Boss Name</label>
                    <input type="text" id="bossName" placeholder="e.g., Absolute Radiance (P5)">
                </div>

                <!-- Genre Selector -->
                <div class="form-group">
                    <label>Boss Genre (Adjusts Calculation Weights)</label>
                    <div class="genre-selector">
                        <div class="genre-option active" onclick="setGenre('action')" id="genre-action">Action</div>
                        <div class="genre-option" onclick="setGenre('tactical')" id="genre-tactical">Tactical</div>
                        <div class="genre-option" onclick="setGenre('endurance')" id="genre-endurance">Endurance</div>
                    </div>
                    <div class="help-text" id="genre-help">Standard fast-paced mechanical fights.</div>
                </div>

                <div class="form-group">
                    <label>Mechanical Intensity (MI)</label>
                    <div class="slider-wrapper">
                        <button class="slider-btn" onclick="adjustSlider('MI', -0.1)">-</button>
                        <input type="range" id="sliderMI" min="1" max="10" step="0.1" value="5.0" oninput="updateSlider('MI')">
                        <button class="slider-btn" onclick="adjustSlider('MI', 0.1)">+</button>
                        <div class="slider-value" id="valueMI">5.0</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Endurance Factor (EF)</label>
                    <div class="slider-wrapper">
                        <button class="slider-btn" onclick="adjustSlider('EF', -0.1)">-</button>
                        <input type="range" id="sliderEF" min="1" max="10" step="0.1" value="5.0" oninput="updateSlider('EF')">
                        <button class="slider-btn" onclick="adjustSlider('EF', 0.1)">+</button>
                        <div class="slider-value" id="valueEF">5.0</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Pattern Complexity (PC)</label>
                    <div class="slider-wrapper">
                        <button class="slider-btn" onclick="adjustSlider('PC', -0.1)">-</button>
                        <input type="range" id="sliderPC" min="1" max="10" step="0.1" value="5.0" oninput="updateSlider('PC')">
                        <button class="slider-btn" onclick="adjustSlider('PC', 0.1)">+</button>
                        <div class="slider-value" id="valuePC">5.0</div>
                    </div>
                </div>

                <!-- Improved Input Group: Build -->
                <div class="form-group">
                    <label>Build Quality (Custom or Preset)</label>
                    <div class="input-group">
                        <input type="number" id="buildInput" step="0.05" value="1.0">
                        <select id="buildSelect" onchange="syncInput('build')">
                            <option value="" disabled selected>Select Preset...</option>
                            <option value="0.65">God-tier (0.65x)</option>
                            <option value="0.75">Optimized (0.75x)</option>
                            <option value="0.85">Good (0.85x)</option>
                            <option value="1.0">Standard (1.0x)</option>
                            <option value="1.25">Suboptimal (1.25x)</option>
                            <option value="1.5">Poor (1.5x)</option>
                            <option value="2.0">Challenge Run (2.0x)</option>
                            <option value="3.0">Extreme Restriction (3.0x)</option>
                        </select>
                    </div>
                    <div class="help-text">1.0 is standard. Lower is better gear.</div>
                </div>

                <!-- Improved Input Group: Consistency -->
                <div class="form-group">
                    <label>Consistency / Hitless Requirement</label>
                    <div class="input-group">
                        <input type="number" id="consistencyInput" step="0.1" value="1.0">
                        <select id="consistencySelect" onchange="syncInput('consistency')">
                            <option value="" disabled selected>Select Preset...</option>
                            <option value="1.0">Normal (1.0x)</option>
                            <option value="1.5">Low-Margin (1.5x)</option>
                            <option value="2.5">Near-Hitless (2.5x)</option>
                            <option value="3.5">Hitless Required (3.5x)</option>
                            <option value="4.5">Frame-Perfect Hitless (4.5x)</option>
                            <option value="6.0">Extended Frame-Perfect (6.0x)</option>
                        </select>
                    </div>
                </div>

                <button onclick="calculateDifficulty()">Calculate Sans Scale</button>

                <div id="result" style="display: none;" class="result-box">
                    <div style="font-size: 0.9rem; color: var(--color-text-secondary);">Sans Scale Magnitude</div>
                    <div class="result-magnitude" id="resultSS">-</div>
                    <div class="result-multiplier" id="resultMult">-</div>
                    <div class="result-tier" id="resultTier">-</div>
                </div>

                <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="secondary" onclick="addToComparison()">Add to Comparison</button>
                    <button class="secondary" onclick="saveToDatabase()">Save to Database</button>
                </div>
            </div>

            <!-- Database Panel -->
            <div class="card">
                <h2>Boss Database</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('all')">All Bosses</div>
                    <div class="tab" onclick="switchTab('beatable')">Below Ceiling</div>
                    <div class="tab" onclick="switchTab('unbeatable')">Above Ceiling</div>
                </div>
                
                <div style="margin-bottom: 12px; text-align: right;">
                    <button class="secondary" style="padding: 6px 12px; font-size: 0.85rem; width: auto;" onclick="resetDatabase()">Reset to Defaults</button>
                </div>

                <div class="database" id="bossDatabase">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Comparison Panel -->
        <div class="card">
            <h2>Comparison View</h2>
            <div id="comparisonView">
                <p style="text-align: center; color: var(--color-text-secondary);">
                    Calculate a boss or select from the database to start comparing
                </p>
            </div>
        </div>
    </div>

    <script>
        // Updated SANS_REFERENCE to match Sans (Tactical) calculation:
        // (5.5*0.25) + (7.0*0.30) + (7.5*0.45) = 1.375 + 2.1 + 3.375 = 6.85
        const SANS_REFERENCE = 6.85;

        // Weights configuration
        const WEIGHTS = {
            action: { MI: 0.45, EF: 0.35, PC: 0.20 },
            tactical: { MI: 0.25, EF: 0.30, PC: 0.45 },
            endurance: { MI: 0.30, EF: 0.50, PC: 0.20 }
        };

        const GENRE_HELP = {
            action: "Standard fast-paced mechanical fights. Focus on reaction time (MI).",
            tactical: "Puzzle bosses, heavy memorization, or complex gimmicks. Focus on Pattern Complexity (PC).",
            endurance: "Marathon fights, Boss Rushes (e.g., P5), or attrition battles. Focus on Endurance (EF)."
        };

        let currentGenre = 'action';

        const defaultBosses = [
            // Undertale / Deltarune
            { id: "ut_1", name: "Sans", MI: 5.5, EF: 7.0, PC: 7.5, build: 1.0, consistency: 1.0, genre: 'tactical', SS: 1.00 },
            { id: "ut_2", name: "Undyne the Undying", MI: 6.5, EF: 6.0, PC: 5.0, build: 1.0, consistency: 1.0, genre: 'action', SS: 0.88 },
            { id: "ut_3", name: "Jevil", MI: 6.5, EF: 4.5, PC: 7.0, build: 1.0, consistency: 1.0, genre: 'action', SS: 0.86 },
            { id: "ut_4", name: "Spamton NEO (Snowgrave)", MI: 6.0, EF: 5.0, PC: 6.0, build: 1.0, consistency: 1.0, genre: 'action', SS: 0.82 },
            
            // Hollow Knight - Standard / Dream
            { id: "hk_1", name: "Nightmare King Grimm", MI: 7.5, EF: 4.5, PC: 8.5, build: 1.0, consistency: 1.0, genre: 'action', SS: 0.97 },
            { id: "hk_2", name: "Pure Vessel", MI: 8.5, EF: 5.5, PC: 9.0, build: 1.0, consistency: 1.0, genre: 'action', SS: 1.08 },
            { id: "hk_3", name: "Lost Kin", MI: 7.0, EF: 6.0, PC: 6.0, build: 1.0, consistency: 1.0, genre: 'action', SS: 0.96 },
            { id: "hk_4", name: "Sisters of Battle", MI: 8.0, EF: 5.0, PC: 7.0, build: 1.0, consistency: 1.0, genre: 'action', SS: 1.00 },
            
            // Hollow Knight - Radiance Variants
            { id: "hk_absrad_base", name: "Absolute Radiance (Hall of Gods)", MI: 9.0, EF: 7.5, PC: 9.5, build: 1.0, consistency: 1.0, genre: 'action', SS: 1.15 },
            { id: "hk_absrad_p5", name: "Absolute Radiance (P5 Finale)", MI: 9.0, EF: 10.0, PC: 9.5, build: 1.0, consistency: 1.0, genre: 'endurance', SS: 1.28 },
            { id: "hk_absrad_double", name: "AbsRad (Ascended/Double Dmg)", MI: 9.0, EF: 7.5, PC: 9.5, build: 1.0, consistency: 1.5, genre: 'action', SS: 1.33 },
            { id: "hk_absrad_hitless", name: "AbsRad (Radiant/Hitless)", MI: 9.5, EF: 8.5, PC: 10.0, build: 1.0, consistency: 3.5, genre: 'action', SS: 1.70 },

            // Modded / Community
            { id: "mod_1", name: "Any Radiance 2.0", MI: 10.0, EF: 10.0, PC: 10.0, build: 1.0, consistency: 4.0, genre: 'action', SS: 1.77 },
            { id: "mod_2", name: "Any Radiance 3.0", MI: 10.0, EF: 10.0, PC: 10.0, build: 1.0, consistency: 5.5, genre: 'action', SS: 1.90 },
            { id: "mod_3", name: "Pale Court (Boss Rush)", MI: 9.0, EF: 9.0, PC: 9.0, build: 1.0, consistency: 1.0, genre: 'endurance', SS: 1.14 },
            { id: "mod_4", name: "Inferno King Grimm", MI: 8.5, EF: 5.0, PC: 9.0, build: 1.0, consistency: 1.0, genre: 'action', SS: 1.05 }
        ];

        let bossDatabase = [];
        let comparisonBosses = [];
        let currentTab = 'all';

        // --- Core Functions ---

        function loadDatabase() {
            // Version bump to clear old storage (v5 -> v6 beta)
            const saved = localStorage.getItem('bossDatabase_beta_v1'); 
            if (saved) {
                bossDatabase = JSON.parse(saved);
                // Migration logic for old data
                bossDatabase.forEach(boss => {
                    if (!boss.id) boss.id = 'migrated_' + Math.random().toString(36).substr(2, 9);
                    if (!boss.genre) boss.genre = 'action';
                });
            } else {
                bossDatabase = [...defaultBosses];
                saveDatabase();
            }
        }

        function saveDatabase() {
            localStorage.setItem('bossDatabase_beta_v1', JSON.stringify(bossDatabase));
        }

        function resetDatabase() {
            if (confirm('Reset database to defaults?')) {
                bossDatabase = [...defaultBosses];
                saveDatabase();
                renderDatabase();
            }
        }

        // --- UI Interactions ---

        function setGenre(genre) {
            currentGenre = genre;
            // Visual Update
            document.querySelectorAll('.genre-option').forEach(el => el.classList.remove('active'));
            document.getElementById('genre-' + genre).classList.add('active');
            
            // Update help text
            document.getElementById('genre-help').textContent = GENRE_HELP[genre];

            // Recalculate if result is visible
            if(document.getElementById('result').style.display === 'block') {
                calculateDifficulty();
            }
        }

        function updateSlider(param) {
            const value = document.getElementById('slider' + param).value;
            document.getElementById('value' + param).textContent = parseFloat(value).toFixed(1);
        }

        function adjustSlider(param, amount) {
            const slider = document.getElementById('slider' + param);
            let newValue = parseFloat(slider.value) + amount;
            // Clamp value
            if (newValue > 10) newValue = 10;
            if (newValue < 1) newValue = 1;
            
            slider.value = newValue;
            updateSlider(param);
        }

        function syncInput(type) {
            // Copies value from Dropdown to Text Input
            const select = document.getElementById(type + 'Select');
            const input = document.getElementById(type + 'Input');
            if (select.value) {
                input.value = select.value;
            }
        }

        // --- Calculation Logic ---

        function calculateSansScale(MI, EF, PC, buildMod, consistencyMod, genre) {
            const w = WEIGHTS[genre] || WEIGHTS.action;
            const baseScore = (MI * w.MI) + (EF * w.EF) + (PC * w.PC);
            const adjustedScore = baseScore * buildMod * consistencyMod;
            const ratio = adjustedScore / SANS_REFERENCE;
            
            let magnitude;
            // Using a threshold slightly below 1 to prevent floating point jitter
            if (ratio >= 0.99999) {
                magnitude = Math.log10(ratio) + 1.0;
            } else {
                magnitude = (ratio - 1.0) * 0.5 + 1.0;
            }
            
            // Snap to 1.00 if very close (fixes the 1.00 vs 1.0000001 issue)
            if (Math.abs(magnitude - 1.0) < 0.005) {
                magnitude = 1.00;
            }

            const multiplier = Math.pow(10, magnitude - 1.0);
            
            return {
                magnitude: magnitude,
                multiplier: multiplier
            };
        }

        function getTier(SS) {
            if (SS < 1.05) return { name: "Baseline", class: "tier-baseline" };
            if (SS < 1.15) return { name: "Hard", class: "tier-hard" };
            if (SS < 1.30) return { name: "Very Hard", class: "tier-very-hard" };
            if (SS < 1.50) return { name: "Extreme", class: "tier-extreme" };
            if (SS < 2.00) return { name: "Practically Unbeatable", class: "tier-unbeatable" };
            return { name: "Near Impossible", class: "tier-impossible" };
        }

        function calculateDifficulty() {
            const MI = parseFloat(document.getElementById('sliderMI').value);
            const EF = parseFloat(document.getElementById('sliderEF').value);
            const PC = parseFloat(document.getElementById('sliderPC').value);
            
            // Read from Input, not Select
            const buildMod = parseFloat(document.getElementById('buildInput').value) || 1.0;
            const consistencyMod = parseFloat(document.getElementById('consistencyInput').value) || 1.0;

            const result = calculateSansScale(MI, EF, PC, buildMod, consistencyMod, currentGenre);
            const tier = getTier(result.magnitude);

            document.getElementById('resultSS').textContent = `SS = ${result.magnitude.toFixed(2)}`;
            document.getElementById('resultMult').textContent = `${result.multiplier.toFixed(2)}x harder than Sans`;
            document.getElementById('resultTier').innerHTML = `<span class="tier-badge ${tier.class}">${tier.name}</span>`;
            document.getElementById('result').style.display = 'block';

            window.currentCalculation = {
                id: 'temp_' + Date.now(),
                name: document.getElementById('bossName').value || "Custom Boss",
                MI, EF, PC,
                build: buildMod,
                consistency: consistencyMod,
                genre: currentGenre,
                SS: result.magnitude
            };
        }

        // --- Database & Comparison ---

        function loadBoss(id) {
            const boss = bossDatabase.find(b => b.id === id);
            if (!boss) return;

            document.getElementById('bossName').value = boss.name;
            document.getElementById('sliderMI').value = boss.MI;
            document.getElementById('sliderEF').value = boss.EF;
            document.getElementById('sliderPC').value = boss.PC;
            document.getElementById('buildInput').value = boss.build;
            document.getElementById('consistencyInput').value = boss.consistency;
            
            // Set genre
            setGenre(boss.genre || 'action');

            updateSlider('MI');
            updateSlider('EF');
            updateSlider('PC');
            
            calculateDifficulty();
            
            // Visual highlight
            document.querySelectorAll('.boss-entry').forEach(el => el.classList.remove('selected'));
            const entry = document.getElementById(`entry-${id}`);
            if(entry) entry.classList.add('selected');
        }

        function renderDatabase() {
            const container = document.getElementById('bossDatabase');
            let bosses = [...bossDatabase];

            // Sorting by SS descending
            bosses.sort((a, b) => b.SS - a.SS);

            if (currentTab === 'beatable') {
                bosses = bosses.filter(b => b.SS < 1.30);
            } else if (currentTab === 'unbeatable') {
                bosses = bosses.filter(b => b.SS >= 1.30);
            }

            let html = '';
            
            bosses.forEach((boss) => {
                const tier = getTier(boss.SS);
                // Recalculate based on current math to ensure display consistency
                const result = calculateSansScale(boss.MI, boss.EF, boss.PC, boss.build, boss.consistency, boss.genre || 'action');
                
                html += `
                    <div id="entry-${boss.id}" class="boss-entry" onclick="loadBoss('${boss.id}')">
                        <div class="boss-name">
                            ${boss.name}
                            <span class="tier-badge ${tier.class}">${tier.name}</span>
                        </div>
                        <div class="boss-stats">
                            <span class="boss-magnitude">SS = ${result.magnitude.toFixed(2)}</span>
                            <span>Type: ${boss.genre || 'action'}</span>
                            <span>MI: ${boss.MI}</span>
                            <span>EF: ${boss.EF}</span>
                            <span>PC: ${boss.PC}</span>
                            <span>Build: ${boss.build}x</span>
                            <span>Cons: ${boss.consistency}x</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function addToComparison() {
            if (!window.currentCalculation) {
                alert("Please calculate a boss first!");
                return;
            }

            const exists = comparisonBosses.find(b => b.name === window.currentCalculation.name && b.SS === window.currentCalculation.SS);
            if (exists) {
                alert("This boss result is already in the comparison!");
                return;
            }

            comparisonBosses.push({...window.currentCalculation});
            updateComparisonView();
        }

        function updateComparisonView() {
            const container = document.getElementById('comparisonView');
            
            if (comparisonBosses.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--color-text-secondary);">
                        Calculate a boss or select from the database to start comparing
                    </p>
                `;
                return;
            }

            const sorted = [...comparisonBosses].sort((a, b) => a.SS - b.SS);

            let html = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Boss</th>
                            <th>SS</th>
                            <th>Mult</th>
                            <th>Genre</th>
                            <th>MI</th>
                            <th>EF</th>
                            <th>PC</th>
                            <th>Build</th>
                            <th>Cons</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sorted.forEach((boss, index) => {
                const tier = getTier(boss.SS);
                const result = calculateSansScale(boss.MI, boss.EF, boss.PC, boss.build, boss.consistency, boss.genre || 'action');
                
                html += `
                    <tr>
                        <td><strong>${boss.name}</strong></td>
                        <td style="color: var(--color-primary); font-weight: 600;">${result.magnitude.toFixed(2)}</td>
                        <td style="color: var(--color-warning);">${result.multiplier.toFixed(2)}x</td>
                        <td><small>${boss.genre || 'action'}</small></td>
                        <td>${boss.MI}</td>
                        <td>${boss.EF}</td>
                        <td>${boss.PC}</td>
                        <td>${boss.build}</td>
                        <td>${boss.consistency}</td>
                        <td><button class="secondary" style="padding: 4px 8px; font-size: 0.8rem; width: auto;" onclick="removeFromComparison(${index})">X</button></td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="secondary" onclick="clearComparison()">Clear All</button>
                </div>
            `;

            container.innerHTML = html;
        }

        function removeFromComparison(index) {
            comparisonBosses.splice(index, 1);
            updateComparisonView();
        }

        function clearComparison() {
            comparisonBosses = [];
            updateComparisonView();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            renderDatabase();
        }

        function saveToDatabase() {
            if (!window.currentCalculation) {
                alert("Please calculate a boss first!");
                return;
            }

            const newBoss = {...window.currentCalculation, id: 'custom_' + Date.now()};
            
            // Check if name exists to ask for update
            const existingIndex = bossDatabase.findIndex(b => b.name === newBoss.name);
            
            if (existingIndex >= 0) {
                if (confirm(`"${newBoss.name}" already exists. Overwrite?`)) {
                    // Keep the old ID if overwriting
                    newBoss.id = bossDatabase[existingIndex].id;
                    bossDatabase[existingIndex] = newBoss;
                    alert("Boss updated!");
                } else {
                    return; // Cancelled
                }
            } else {
                bossDatabase.push(newBoss);
                alert("Boss added!");
            }
            
            saveDatabase();
            renderDatabase();
        }

        function toggleGuide() {
            const content = document.getElementById('guideContent');
            content.classList.toggle('active');
        }

        // Initialize
        loadDatabase();
        renderDatabase();
    </script>
</body>
</html>
